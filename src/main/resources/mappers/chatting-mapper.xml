<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="chattingMapper">

	<resultMap type="chatRoom" id="chatroom_rm">
		<id property="chatRoomId" column="CHAT_ROOM_ID" />
		<result property="chatStatus" column="CHAT_STATUS" />
		<result property="memberId" column="MEMBER_ID" />
		<result property="memberNick" column="MEMBER_NICK" />

	</resultMap>

	<resultMap type="chatMessage" id="chatMessage_rm">
		<id property="chatMessageId" column="CHAT_MESSAGE_ID" />

		<result property="message" column="MESSAGE" />
		<result property="createRDate" column="CHAT_CREATE_DT" />
		<result property="chatRoomId" column="CHAT_ROOM_ID" />

		<result property="memberId" column="MEMBER_ID" />
		<result property="memberNick" column="MEMBER_NICK" />
	</resultMap>

	<!--========================================================================================= -->

	<!-- 채팅방 목록 조회 -->

	<select id="selectChatRoomList" resultMap="chatroom_rm">
		SELECT A.CHAT_ROOM_ID,
		B.MEMBER_NICK
		FROM CHAT_ROOM A
		JOIN MEMBER B ON A.MEMBER_ID =
		B.MEMBER_ID
		WHERE A.CHAT_STATUS = 'Y'
		ORDER BY A.CHAT_ROOM_ID DESC
	</select>

	<select id="selectChatId" resultMap="chatroom_rm">
		SELECT *
		FROM CHAT_ROOM
		WHERE MEMBER_ID = #{memberId}
	</select>
	
	<!-- 채팅방 만들기 -->
	<insert id="openChatRoom" useGeneratedKeys="true">
		<selectKey keyProperty="chatRoomId" resultType="_int"
			order="BEFORE">
			SELECT SEQ_CHAT_NO.NEXTVAL FROM DUAL
		</selectKey>

		INSERT INTO CHAT_ROOM (CHAT_ROOM_ID, CHAT_STATUS, MEMBER_ID)
		VALUES
		(#{chatRoomId}, DEFAULT, #{memberId})
	</insert>



	<!-- 채팅방 참여 여부 확인 -->
	<select id="joinCheck" resultType="_int">
		SELECT COUNT(*) FROM
		CHAT_ROOM_JOIN
		WHERE CHAT_ROOM_ID = #{chatRoomId}
		AND MEMBER_ID =
		#{memberId}
	</select>

	<!-- 채팅방 참여하기 -->
	<insert id="joinChatRoom">
		INSERT INTO CHAT_ROOM_JOIN
		VALUES(#{chatRoomId},#{memberId})
	</insert>

	<!-- 채팅 메세지 목록 조회 -->
	<select id="selectChatMessage" resultMap="chatMessage_rm">
		SELECT MESSAGE,
		CHAT_CREATE_DT, MEMBER_ID, MEMBER_NICK
		FROM CHAT_MESSAGE
		JOIN MEMBER
		USING(MEMBER_Id)
		WHERE CHAT_ROOM_ID = #{chatRoomId}
 
	 
 
	</select>

</mapper>