<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="boardMapper">
  
   <resultMap type="boardType" id="boardType_rm">
      <id property="boardCode" column="BOARD_CD" />
      <result property ="boardName" column="BOARD_NAME"/>
   </resultMap>
   <resultMap type="board" id = "board_rm">
      <id property="boardId" column="BOARD_ID" />
      <result property="boardCode" column="BOARD_CD" />
      <result property="boardTitle" column="BOARD_TITLE" />
      <result property="boardContent" column="BOARD_CONTENT" />
      <result property="boardFiles" column="BOARD_FILE1" />
      <result property="boardDt" column="BOARD_DT" />
      <result property="boardCNT" column="READ_CNT" />
      <result property="boardAuth" column="BOARD_AUTH" />
      <result property="memberId" column="MEMBER_ID" />      
   </resultMap>
   
   <resultMap type = "boarddetail" id = "boardDetail_rm">
      <id property = "boardId" column = "BOARD_ID"/>
      <result property = "boardTitle" column = "BOARD_TITLE"/>
      <result property = "boardContent" column = "BOARD_CONTENT"/>
      <result property = "createDate" column = "BOARD_DT"/>
      <result property = "updateDate" column = "BOARD_UPDT"/>
      <result property = "readCount" column = "READ_CNT"/>
      <result property = "memberNickname" column = "MEMBER_NICK"/>
      <result property = "profileImage" column = "BOARD_FILE1"/>
      <result property = "memberId" column = "MEMBER_ID"/>
      <result property = "boardCode" column = "BOARD_CD"/>
      <!-- selectImageList란 select가 들어간 imagelist를 select하는 것. -->
      <collection property = "imageList" column = "BOARD_ID" javaType = "java.util.ArrayList" ofType="boardImage" select="selectImageList"/>
   </resultMap>
   
   
   <!-- 이미지 정보 조회용 resultMap -->
   <resultMap type="boardImage" id="boardImage_rm">
      <id property="imageNo" column="IMG_NO" />
      <result property="imageReName" column="IMG_RENAME" />
      <result property="imageOriginal" column="IMG_ORIGINAL" />
      <result property="imageLevel" column="IMG_LEVEL" />
      <result property="boardId" column="BOARD_ID" />
      <result property ="image_ST" column = "IMAGE_ST"/>
   </resultMap>
   
   
   <!-- 특정 게시글 이미지 목록 조회 -->
   <select id="selectImageList" resultMap="boardImage_rm">
      SELECT * FROM BOARD_IMG
      WHERE BOARD_ID = #{boardId}
      AND IMAGE_ST = 'N'
      ORDER BY IMG_LEVEL
   </select>
   
   
   <select id = "selectBoardType" resultMap = "boardType_rm">
      SELECT BOARD_CD,BOARD_NAME
      FROM BOARD_TYPE
   </select>
   <select id = "getListCount" resultType="_int">
      SELECT count(*) 
      FROM board
      WHERE BOARD_CD = #{boardCode}
      AND BOARD_ST = 'N'
   </select>
   <select id="selectBoardList" resultMap="board_rm">
      SELECT BOARD_ID,
      BOARD_CD,
      BOARD_TITLE,
      READ_CNT,
      BOARD_CONTENT,
      CASE WHEN SYSDATE - BOARD_DT &lt; 1
          THEN TO_CHAR(BOARD_DT, 'HH:MI')
          ELSE TO_CHAR(BOARD_DT, 'YYYY-MM-DD')
      END BOARD_DT,
      (SELECT IMG_RENAME FROM BOARD_IMG
       WHERE BOARD.BOARD_ID = BOARD_IMG.BOARD_ID
       AND IMG_LEVEL = 0 AND IMAGE_ST = 'N') BOARD_FILE1,   
      BOARD_AUTH,
      MEMBER_ID
   FROM BOARD
   JOIN BOARD_TYPE USING(BOARD_CD)
   JOIN MEMBER USING(MEMBER_ID)
   WHERE BOARD_ST = 'N'
   AND BOARD_CD = #{boardCode}
   ORDER BY BOARD_ID DESC
      
   </select>
   
   <select id = "selectBoardDetail" parameterType ="_int" resultMap = "boardDetail_rm">
   	  SELECT b.BOARD_ID, b.BOARD_TITLE, b.BOARD_CONTENT,
      TO_CHAR(b.BOARD_DT, 'YYYY"년" MM"월" DD"일" HH24:MI:SS') AS BOARD_DT,
      TO_CHAR(b.BOARD_UPDT, 'YYYY"년" MM"월" DD"일" HH24:MI:SS') AS BOARD_UPDT,
   	  b.READ_CNT, b.MEMBER_NICK, b.MEMBER_ID, b.BOARD_FILE1
	  FROM BOARD b 
	  JOIN MEMBER m ON b.MEMBER_ID = m.MEMBER_ID
	  JOIN BOARD_TYPE t ON b.BOARD_CD  = t.BOARD_CD 
	  WHERE BOARD_ID = #{boardId}
	  AND BOARD_ST = 'N'
   </select>
   
    
   <select id = "selectWriterBoardList" resultMap = "board_rm">
		SELECT BOARD_ID, BOARD_CD, BOARD_TITLE, BOARD_CONTENT, BOARD_FILE1, TO_CHAR(BOARD_DT, 'YYYY"년" MM"월" DD"일" HH24:MI:SS') BOARD_DT,
		READ_CNT, BOARD_AUTH, MEMBER_ID
		FROM BOARD
		WHERE MEMBER_ID = #{memberId}
   </select>
   
   <insert id = "sendLetter" parameterType="map">
   		INSERT INTO MESSAGE (MESSAGE_KEY, SEND_EMAIL, GET_EMAIL, MESSAGE_TITLE, MESSAGE_CONTENT, MESSAGE_STATUS, MESSAGE_DT, MEMBER_ID2)
SELECT
    SEQ_MESSAGE_NO.NEXTVAL,
    #{writerName},
    #{sendName},
    #{sendTitle},
    #{sendText},
    0,
    SYSDATE,
    (SELECT MEMBER_ID FROM MEMBER WHERE MEMBER_ID = #{memberId})
FROM
    dual
   </insert>
   <insert id="insertImage" parameterType="map" useGeneratedKeys = "true">
  <selectKey keyProperty ="boardId" resultType ="_int" order ="BEFORE">
	SELECT SEQ_BOARD_NO.NEXTVAL FROM DUAL
	</selectKey>
  INSERT INTO BOARD_IMG (IMG_ID, IMG_RENAME, IMG_ORIGINAL, IMAGE_LEVEL, BOARD_ID)
  VALUES
  <foreach collection="profileImage" item="image" separator=",">
    (SEQ_IMG_NO, #{image.imageReName}, #{image.imageOriginal}, #{image.imageLevel}, #{boardId})
  </foreach>
</insert>


	<insert id = "writeBoard" parameterType = "detail" useGeneratedKeys = "true">
	<selectKey keyProperty ="boardId" resultType ="_int" order ="BEFORE">
	SELECT SEQ_BOARD_NO.NEXTVAL FROM DUAL
	</selectKey>
	INSERT INTO BOARD(BOARD_ID, BOARD_CD,BOARD_TITLE,BOARD_CONTENT,BOARD_FILE1,BOARD_DT,READ_CNT,MEMBER_ID,BOARD_ST,MEMBER_NICK,BOARD_AUTH) 
	VALUES(#{boardId},#{boardCode},#{boardTitle},#{boardContent},#{profileImage},SYSDATE,0,#{memberId},'N',#{memberNickname},'N')
	</insert>
	
	<update id = "updateBoard" parameterType = "detail">
	UPDATE BOARD 
	SET BOARD_TITLE = #{boardTitle}, BOARD_CONTENT = #{boardContent}, BOARD_FILE1 = #{profileImage}
	WHERE BOARD_ID = #{boardId}
	</update>
	
	<insert id="insertBoardImage" parameterType="detail" useGeneratedKeys="true">
    <selectKey keyProperty="boardId" resultType="int" order="BEFORE">
        SELECT BOARD_ID
        FROM (
          SELECT BOARD_ID
          FROM BOARD
          WHERE MEMBER_ID = #{memberId}
          ORDER BY BOARD_DT DESC
        ) WHERE ROWNUM = 1
    </selectKey>
    INSERT INTO BOARD_IMG(IMG_ID, IMG_RENAME, IMG_ORIGINAL, IMG_LEVEL, BOARD_ID)
    VALUES
    <foreach collection="imageList" item="image" separator=",">
    	    (SEQ_BOARD_IMG_NO.NEXTVAL, #{image.imageReName}, #{image.imageOriginal}, #{image.imageLevel}, #{boardId})	
    </foreach>
	</insert>
	
	
	<insert id = "updateBoardImage" parameterType="detail">
		INSERT INTO BOARD_IMG(IMG_ID, IMG_RENAME, IMG_ORIGINAL, IMG_LEVEL, BOARD_ID)
		VALUES
		<foreach collection="imageList" item="image" separator=",">
    	    (SEQ_BOARD_IMG_NO.NEXTVAL, #{image.imageReName}, #{image.imageOriginal}, #{image.imageLevel}, #{image.boardId})
   		 </foreach>
	</insert>
	
	
	<update id = "deleteBeforeImage">
	UPDATE BOARD_IMG
	SET IMAGE_ST = 'Y'
	WHERE BOARD_ID=#{boardId}
	</update>
	
	<!-- 관리자 게시판 페이지네이션 -->	
	<select id="getAdminListCount" resultType="int">
	   SELECT count(*) 
	   FROM board 
	</select>
	
	<!-- 관리자 게시판 화면 출력 -->	
	<select id="selectAdminBoardList" resultMap="board_rm">
	   SELECT BOARD_ID,
	   BOARD_TITLE,
	   READ_CNT,
	   BOARD_CONTENT,
	   BOARD_DT,
	   BOARD_AUTH
	FROM BOARD
	ORDER BY BOARD_ID DESC
	</select>
	
	<!-- 관리자 게시판 검색 -->
		<select id="searchAdminBoardList" resultMap="board_rm">
	   SELECT BOARD_ID,
	   BOARD_TITLE,
	   BOARD_CONTENT,
	   READ_CNT,
	   BOARD_AUTH,
	   BOARD_DT,
	   MEMBER_NICK
	FROM BOARD
	 WHERE
	
	<!-- 검색어가 있을 경우 -->
	<if test='query != null and query != ""'>
	    
	      <choose>
	         <when test='key == "tc"'>
	            (BOARD_TITLE LIKE '%' || #{query} || '%'
	            OR
	            BOARD_CONTENT LIKE '%' || #{query} || '%')
	         </when>
	         <when test='key == "w"'>
	            MEMBER_NICK LIKE '%' || #{query} || '%'
	         </when>
	      </choose>
	   </if>
	ORDER BY BOARD_ID DESC
	</select>

  	<update id = "deleteBoard" parameterType="map">
		UPDATE BOARD
		SET(BOARD_ST = 'Y')
		WHERE BOARD_ID = #{boardId}
		AND BOARD_CD = #{boardCode}
	</update>
	<select id="searchAdminListCount" resultType="int">
   SELECT COUNT(*)
   FROM BOARD
   
   WHERE
   <!-- 검색어가 있을 경우 -->
   <if test='query != null and query != ""'>
     
      <choose>
         <when test='key == "tc"'>
            (BOARD_TITLE LIKE '%' || #{query} || '%'
            OR
            BOARD_CONTENT LIKE '%' || #{query} || '%')
         </when>
         <when test='key == "w"'>
            MEMBER_NICK LIKE '%' || #{query} || '%'
         </when>
      </choose>
   </if>
   ORDER BY BOARD_ID DESC
</select>


</mapper>

